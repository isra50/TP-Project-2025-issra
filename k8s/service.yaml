#!/bin/bash
echo "üß™ TEST COMPLET DU SERVICE"
echo "=========================="

SERVICE_IP="192.168.49.2"
SERVICE_NAME="tp-projet-service"
NAMESPACE="tp-projet-2025"

echo "1. üìä √âtat du service :"
kubectl get svc $SERVICE_NAME -n $NAMESPACE -o wide

echo -e "\n2. üîó Endpoints :"
ENDPOINTS=$(kubectl get endpoints $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.subsets[0].addresses[*].ip}')
if [ ! -z "$ENDPOINTS" ]; then
    echo "   ‚úÖ Service a des endpoints : $ENDPOINTS"
else
    echo "   ‚ùå Service n'a pas d'endpoints"
fi

echo -e "\n3. üåê Test externe (NodePort) :"
echo "   Test sur $SERVICE_IP:30080"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://$SERVICE_IP:30080/ 2>/dev/null || echo "TIMEOUT")
if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "302" ] || [ "$HTTP_CODE" == "401" ] || [ "$HTTP_CODE" == "404" ]; then
    echo "   ‚úÖ Service r√©pond (HTTP $HTTP_CODE)"
    echo "   Note: 404/401 signifie que l'application r√©pond mais avec Spring Security"
elif [ "$HTTP_CODE" == "TIMEOUT" ]; then
    echo "   ‚ùå Service ne r√©pond pas (timeout)"
else
    echo "   ‚ö†Ô∏è  Service r√©pond avec code $HTTP_CODE"
fi

echo -e "\n4. üîç Test interne (depuis le cluster) :"
kubectl run --rm -i --tty test-curl --image=curlimages/curl --restart=Never -n $NAMESPACE -- \
  sh -c "curl -s http://$SERVICE_NAME.$NAMESPACE.svc.cluster.local:8080/ || echo 'Test interne termin√©'"

echo -e "\n5. üì° Test de charge :"
echo "   Le service distribue le trafic sur :"
kubectl get pods -n $NAMESPACE -l app=tp-projet -o wide | grep -v NAME

echo -e "\nüéØ CONCLUSION DU SERVICE :"
if [ ! -z "$ENDPOINTS" ] && [ "$HTTP_CODE" != "TIMEOUT" ]; then
    echo "   ‚úÖ SERVICE FONCTIONNEL"
    echo "   - Route le trafic vers les pods"
    echo "   - R√©pond aux requ√™tes"
    echo "   - Probl√®me: Spring Security bloque l'acc√®s public"
else
    echo "   ‚ùå SERVICE D√âFAILLANT"
fi
